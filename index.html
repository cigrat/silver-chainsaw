<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GRID</title>
    <style>
        :root { --bg: #000; --panel: #1a1a1a; --border: #333; --text: #eee; --accent: #0a84ff; }
        
        body { 
            margin: 0; background-color: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            padding-top: 65px; overflow-y: scroll; -webkit-tap-highlight-color: transparent;
        }

        header {
            position: fixed; top: 0; width: 100%; z-index: 1000;
            background: #000; border: none;
            box-shadow: 0 1px 0 0 #222;
        }

        .header-container {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; height: 60px; gap: 12px;
        }

        .logo { font-weight: bold; cursor: pointer; font-size: 16px; color: #fff; white-space: nowrap; flex-shrink: 0; }

        .search-outer {
            display: flex; flex: 1; max-width: 500px; background: #1a1a1a; 
            border-radius: 8px; border: 1px solid var(--border); overflow: hidden;
        }
        
        input[type="text"] {
            flex-grow: 1; background: transparent; border: none; color: #fff;
            padding: 10px 12px; outline: none; font-size: 15px; width: 30px;
        }

        #searchBtn { 
            background: var(--accent); color: #fff; border: none; 
            padding: 0 15px; font-weight: 800; cursor: pointer;
            border-left: 1px solid var(--border);
        }

        /* Fixed Button Alignment */
        .header-right { display: flex; align-items: center; gap: 10px; }
        .control-row { display: flex; gap: 8px; align-items: center; }

        .drop-btn { 
            background: #1a1a1a; border: 1px solid var(--border); color: #fff;
            padding: 0 10px; border-radius: 6px; font-size: 12px; cursor: pointer;
            white-space: nowrap; height: 34px; box-sizing: border-box;
            display: flex; align-items: center; justify-content: center;
            text-align: center;
        }

        select.drop-btn { 
            appearance: none; -webkit-appearance: none; 
            text-align-last: center; 
            padding-right: 10px; 
        }

        .slider-box {
            display: flex; align-items: center; gap: 8px; background: #1a1a1a;
            padding: 0 10px; border-radius: 8px; border: 1px solid var(--border); 
            height: 34px; box-sizing: border-box;
        }
        .slider-box span { font-size: 10px; color: #777; text-transform: uppercase; font-weight: 800; }
        .slider-box b { 
            font-family: monospace; font-size: 15px; color: var(--accent); 
            width: 32px; text-align: center; display: flex; align-items: center;
            justify-content: center; height: 100%; line-height: 1;
        }
        input[type="range"] { cursor: pointer; accent-color: var(--accent); width: 70px; }

        .custom-dropdown { position: relative; }
        .drop-content {
            display: none; position: absolute; top: 100%; right: 0; background: #1c1c1e;
            min-width: 140px; border: 1px solid #444; border-radius: 8px; margin-top: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.8); z-index: 1100;
        }
        .drop-content label {
            display: flex; align-items: center; gap: 10px; padding: 12px;
            cursor: pointer; font-size: 14px; border-bottom: 1px solid #2c2c2e; color: #fff;
        }
        .drop-content label:last-child { border-bottom: none; }
        .show { display: block; }

        #gallery { width: 100%; display: flex; align-items: flex-start; }
        .v-column { flex: 1; display: flex; flex-direction: column; }
        
        .media-item { 
            width: 100%; height: auto; display: block; 
            transition: filter 0.2s ease;
            cursor: pointer;
        }

        /* Reverted Hover: Slightly Darken */
        @media (hover: hover) {
            .media-item:hover { filter: brightness(0.7); }
        }

        .menu-toggle { display: none; }

        @media (max-width: 1150px) {
            .logo { display: none; }
            .header-right { display: none; }
            .menu-toggle { 
                display: block; background: #333; border: none; color: #fff; 
                padding: 0 12px; border-radius: 6px; height: 38px; font-weight: bold;
            }
            .header-container { gap: 8px; }

            #header-right-area.open {
                display: flex; position: absolute; top: 60px; left: 0; right: 0;
                background: #000; flex-direction: column; padding: 15px; 
                gap: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
                border-bottom: 1px solid var(--accent);
            }
            #header-right-area.open .control-row { width: 100%; flex-direction: column; }
            #header-right-area.open .slider-box, 
            #header-right-area.open .drop-btn,
            #header-right-area.open .custom-dropdown { 
                width: 100%; height: 44px; 
            }
            #header-right-area.open input[type="range"] { width: 50%; }
        }

        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center;
        }
        #action-sheet { background: #1c1c1e; width: 90%; max-width: 320px; border-radius: 14px; overflow: hidden; }
        .sheet-btn {
            display: block; width: 100%; padding: 16px; background: transparent; border: none;
            border-bottom: 1px solid #2c2c2e; color: #fff; font-size: 17px; text-align: center;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-container">
            <div class="logo" onclick="location.reload()">GRID</div>
            <div class="search-outer">
                <input type="text" id="searchBar" placeholder="Search tags..." autocomplete="off">
                <button id="searchBtn">GO</button>
            </div>
            <button class="menu-toggle" onclick="document.getElementById('header-right-area').classList.toggle('open')">FILTERS</button>
            <div id="header-right-area" class="header-right">
                <div class="control-row">
                    <select id="ratingSelect" class="drop-btn">
                        <option value="">Any Rating</option>
                        <option value="rating:s">Safe</option>
                        <option value="rating:q">Questionable</option>
                        <option value="rating:e">Explicit</option>
                    </select>
                    <select id="sortSelect" class="drop-btn">
                        <option value="order:id_desc">Newest</option>
                        <option value="order:id_asc">Oldest</option>
                        <option value="order:score">Top Score</option>
                        <option value="order:favcount">Favorites</option>
                        <option value="order:random">Random</option>
                        <option value="order:pool">Pool Order</option>
                    </select>
                </div>
                <div class="control-row">
                    <div class="custom-dropdown">
                        <div class="drop-btn" onclick="toggleDrop()">Type: <span id="typeStatus" style="margin-left:5px; color:var(--accent)">All</span></div>
                        <div id="typeMenu" class="drop-content">
                            <label><input type="checkbox" class="type-chk" value="-type:webm -type:gif" checked data-label="Static"> Static</label>
                            <label><input type="checkbox" class="type-chk" value="type:gif" checked data-label="GIF"> GIF</label>
                            <label><input type="checkbox" class="type-chk" value="type:webm" checked data-label="Video"> Video</label>
                        </div>
                    </div>
                    <select id="resSelect" class="drop-btn">
                        <option value="preview">Thumb</option>
                        <option value="sample" selected>Scaled</option>
                        <option value="file">Full</option>
                    </select>
                </div>
                <div class="control-row">
                    <div class="slider-box">
                        <span>Score</span>
                        <input type="range" id="scoreSlider" min="0" max="100" value="0">
                        <b id="scoreVal">0</b>
                    </div>
                    <div class="slider-box">
                        <span>Cols</span>
                        <input type="range" id="sizeSlider" min="1" max="12" value="6">
                        <b id="sizeVal">6</b>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="gallery"></div>
    <div id="sentinel" style="height: 100px;"></div>

    <div id="modal-overlay" onclick="this.style.display='none'">
        <div id="action-sheet" onclick="event.stopPropagation()">
            <div id="sheet-actions"></div>
            <button class="sheet-btn" style="color:#ff453a; font-weight:bold" onclick="document.getElementById('modal-overlay').style.display='none'">Cancel</button>
        </div>
    </div>

    <script>
        let currentPage = 1, isFetching = false, hasMore = true, currentPosts = [], postCounter = 0;
        const gallery = document.getElementById('gallery'), searchInput = document.getElementById('searchBar');
        const scoreSlider = document.getElementById('scoreSlider'), sizeSlider = document.getElementById('sizeSlider');

        function toggleDrop() { document.getElementById("typeMenu").classList.toggle("show"); }
        window.onclick = (e) => { if (!e.target.closest('.custom-dropdown')) { document.getElementById("typeMenu").classList.remove("show"); }};

        function setDeviceDefaults() {
            const isMobile = window.innerWidth <= 1024;
            const isPool = searchInput.value.includes('pool:');
            let defaultCols = isMobile ? (isPool ? 1 : 2) : (isPool ? 2 : 6);
            sizeSlider.value = defaultCols;
            document.getElementById('sizeVal').innerText = defaultCols;
        }

        function updateTypeLabel() {
            const chks = document.querySelectorAll('.type-chk:checked');
            const label = document.getElementById('typeStatus');
            if (chks.length === 3) label.innerText = "All";
            else if (chks.length === 0) label.innerText = "None";
            else label.innerText = Array.from(chks).map(c => c.dataset.label).join(',');
            loadPosts(true);
        }

        function getMappedScore(val) {
            val = parseInt(val);
            if (val <= 50) return val * 2;
            if (val <= 80) return 100 + (val - 50) * 10;
            return 400 + (val - 80) * 80;
        }

        function setupColumns() {
            gallery.innerHTML = '';
            const count = parseInt(sizeSlider.value);
            for (let i = 0; i < count; i++) {
                const col = document.createElement('div');
                col.className = 'v-column';
                gallery.appendChild(col);
            }
        }

        async function loadPosts(reset = false) {
            if (isFetching || (!hasMore && !reset)) return;
            isFetching = true;
            if (reset) { currentPage = 1; postCounter = 0; hasMore = true; setupColumns(); currentPosts = []; }
            const score = getMappedScore(scoreSlider.value);
            const typeFilters = Array.from(document.querySelectorAll('.type-chk:checked')).map(c => c.value);
            const typeStr = (typeFilters.length === 3 || typeFilters.length === 0) ? "" : `(${typeFilters.join('~')})`;
            const tags = `${searchInput.value} ${document.getElementById('ratingSelect').value} ${document.getElementById('sortSelect').value} ${score > 0 ? 'score:>=' + score : ''} ${typeStr}`.trim();
            const url = `https://e621.net/posts.json?tags=${encodeURIComponent(tags)}&page=${currentPage}&limit=40`;
            try {
                const resp = await fetch(url, { headers: { 'User-Agent': 'Grid/5.6' } });
                const data = await resp.json();
                if (!data.posts || !data.posts.length) hasMore = false;
                else {
                    if (reset) currentPosts = data.posts; else currentPosts.push(...data.posts);
                    renderPosts(data.posts);
                    currentPage++;
                }
            } finally { isFetching = false; }
        }

        function renderPosts(posts) {
            const cols = document.getElementsByClassName('v-column');
            const resType = document.getElementById('resSelect').value;
            posts.forEach(post => {
                if (!post.file || !post.file.url) return;
                const container = document.createElement('div');
                const colIdx = postCounter % cols.length;
                if(cols[colIdx]) cols[colIdx].appendChild(container);
                postCounter++;

                let media;
                const isVideo = post.file.ext === 'webm';

                if (resType === 'preview') {
                    media = document.createElement('img');
                    media.src = post.preview.url;
                } 
                else if (isVideo) {
                    media = document.createElement('video');
                    media.src = post.file.url;
                    media.autoplay = true;
                    media.loop = true;
                    media.muted = true;
                    media.playsInline = true;
                } 
                else {
                    media = document.createElement('img');
                    media.src = (resType === 'sample' && post.sample && post.sample.has) ? post.sample.url : post.file.url;
                }

                media.className = "media-item";
                media.loading = "lazy";

                const handleOp = (e) => {
                    if (e.button === 1 || e.ctrlKey) { window.open(post.file.url, '_blank'); }
                    else if (e.altKey) { window.open(`https://e621.net/posts/${post.id}`, '_blank'); }
                    else if (e.button === 0) { openSheet(post); }
                };
                media.onclick = handleOp;
                media.onauxclick = handleOp;
                container.appendChild(media);
            });
        }

        function openSheet(post) {
            const actions = document.getElementById('sheet-actions');
            actions.innerHTML = `<button class="sheet-btn" onclick="window.open('${post.file.url}')">Open Full Image</button>
                                 <button class="sheet-btn" onclick="window.open('https://e621.net/posts/${post.id}')">View Post Page</button>`;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        sizeSlider.oninput = () => document.getElementById('sizeVal').innerText = sizeSlider.value;
        sizeSlider.onchange = () => loadPosts(true);
        scoreSlider.oninput = () => document.getElementById('scoreVal').innerText = getMappedScore(scoreSlider.value);
        scoreSlider.onchange = () => loadPosts(true);
        document.querySelectorAll('.type-chk').forEach(c => c.onchange = updateTypeLabel);
        document.getElementById('searchBtn').onclick = () => { loadPosts(true); document.getElementById('header-right-area').classList.remove('open'); };
        searchInput.onkeydown = (e) => { if(e.key==='Enter') { loadPosts(true); document.getElementById('header-right-area').classList.remove('open'); } };
        window.onscroll = () => { if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1500) loadPosts(); };

        setDeviceDefaults();
        setupColumns();
        loadPosts(true);
    </script>
</body>
</html>